---
layout: post
title: 데이터를 저장을 위한 비어있는 공간 찾기. Free space Map
date: "2013-04-17 22:10:00 -0500"
categories: postgres FSM free space map
published: true
---
## Free Space Map

데이터파일에서 Tuple이 저장되어 있는 공간과 비어있는 공간을 관리하는 별도의 데이터 구조체입니다. 

새로운 자료의 추가(INSERT) 또는 기존 자료의 변경(UPDATE)이 발생하였을 경우, 테이블에는 새로운 Tuple이 생성됩니다.
Tuple을 생성하기 위해서는 기본적으로 사용하지 않는 새로운 Buffer 할당을 수행하여야 합니다. 메모리 상에서 버퍼를 할당하는 것은 단순하게, 메모리 할당을 통해서 문제를 해결할 수 있지만, 파일 입장에서는 기존에 있는 파일 내용 중 비어 있는 부분을 찾고, 새롭게 생성되는 Tuple의 양에 맞추어서 할당 할 수 있는지 문제를 즉시 확인할 수 있어야 합니다. 

이를 위해서 준비한 기법이 Free space map입니다. 

Freespace Map은 해당 테이블(postgres에서는 Relation이라고 부릅니다만) 정보가 저장되는 대상 데이터 파일에 대하여, Tree 형태의 자료구조를 활용하여, 비어 있는 공간을 즉각 확인할 수 있게 지원해 줍니다.

포스트그레스 8.4이후부터, 개별 테이블 파일에 저장되던 고정 크기 Freespace Map이 독립적인 파일에 저장되도록 변경되었습니다.

### 구조
1. 계층 구조
   데이터 파일 
      - 페이지
         - Tuple

2. 페이지에 저장된 Tuple의 전체 값을 저장하지 않고, 0~255 의 대표값으로 저장합니다. 즉 Page단 한 Byte를 할당합니다. 

3. Tree 구조를 생성하고, Leaf Node의 Max 값이 Parent 값으로 할당합니다.
     
위와 같이 구성할 경우, Tree는 아래와 같은 형태를 취합니다. 


                                             198
                                              |
                                    ----------------------          
                                   198                   124
                                    |                     |
                         ------------------        ------------------
                       56               198       48               124
 

### FSF에서 지원하는 Operation
이럴 경우, 두개의 Operation을 빠르게 처리할 수 있습니다. 

1. 검색하기 : 필요한 양의 Buffer를 가지고 있는 Page 찾기
   : 필요한 양의 Buffer보다 큰 쪽 Node를 대상으로 Leaf Node를 찾습니다. 
   : 필요한 양의 Buffer보다 큰 Node가 N개 이상일 경우에는 임의의 하나를 선택합니다. 

2. 정보 변경하기 : Buffer에 Tuple이 들어가서 대표값이 변경되는 경우, 변경된 값을 해당 leaf Node에 반영하고,
   : 상위 Node를 따라가면서 변경합니다. 만약, 상위 Node의 대표값이 더 큰 경우에는 해당 Node에서 변경을 종료하면 됩니다. 
   

### Tree 구조의 장점

1. 특정 크기 이상의 Page가 필요한 경우, 단순하게, Root Node 검사를 통하여, 적용 가능성을 확인할 수 있습니다. 
2. 자식 노드를 검색하는 방법을 다양하게 구현할 수 있습니다. 이를 통해서 인접 Buffer 할당 또는, 버퍼 분산등을 수행할 수 있습니다. 

### 프로그램에서 FSM를 접근하는 방법
fsm_set_avail() 함수와 fsm_search_avail() 함수를 이용해서 FSM에 접근할 수 있습니다. 
이 두함수를 이용하면 내부에서 활용하는 Tree 구조는 외부에서 보이지 않으며, 단지 빈 슬롯(slot)형태의 목록을 통해서 접근하는 것으로 시뮬레이션할 수 있습니다. 










